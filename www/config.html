<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Pomo</title>
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>

        <div class="nav">
            <div class="nav-item nav-header">
                POMO
            </div>

            <a href="./index.html" class="nav-item nav-link">
                Tasks
            </a>

            <a href="./config.html" class="nav-item nav-link active">
                Config
            </a>
        </div>


        <div class="main">
            <div class="row main-margin">
                <div class="w-3"></div>

                <div class="w-6 modal">
                    <div class="row">
                        <div class="w-6">
                            <div class="form-item">
                                <label for="ssid">SSID</label>
                                <select name="ssid" id="ssid">
                                </select>
                            </div>
                        </div>

                        <div class="w-6">
                            <div class="form-item">
                                <label for="password">Password</label>
                                <input type="password" placeholder="Password" id="password">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="w-4">
                            <button onclick="scan_ssids()" id="scan-button">Scan SSIDs</button>
                        </div>
                        <div class="w-4">
                            <button onclick="connect()" id="connect-button">Connect</button>
                        </div>
                        <div class="w-4">
                            <button onclick="save_config()" id="check-button">Save Connection</button>
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="w-6">
                            <button onclick="reboot()">Reboot Pomo</button>
                        </div>

                        <div class="w-6">
                            <button onclick="reset()">Reset Pomo</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <script>
            function scan_ssids() {
                let http = new XMLHttpRequest();
                let url = '/api/get_ssids';

                let button = document.getElementById('scan-button');
                button.innerHTML = "Scanning...";
                button.disabled = true;

                http.open('GET', url);
                http.send();
                http.onreadystatechange = function() {
                    if (this.readyState == 4) {
                        button.disabled = false;
                        if (http.status == 200) {
                            let data = JSON.parse(http.responseText);

                            let dropdown = document.getElementById('ssid');
                            dropdown.length = 0;

                            let option;
                            for (let i = 0; i < data['ssids'].length; i++) {
                                option = document.createElement('option');
                                option.text = data['ssids'][i];
                                option.value = data['ssids'][i];
                                dropdown.add(option);
                            }

                            button.innerHTML = "Scan Again";
                        } else {
                            button.innerHTML = "Error, please try again!";
                        }
                    }
                }
            }

            function connect() {
                let ssid = document.getElementById('ssid');
                let password = document.getElementById('password');

                let button = document.getElementById('connect-button');
                button.innerHTML = "Connecting...";
                button.disabled = true;

                let http = new XMLHttpRequest();
                let url = '/api/connect';
                http.open("POST", url);
                http.send(JSON.stringify({ssid: ssid.value, password: password.value}));

                http.onreadystatechange = function() {
                    if (this.readyState == 4) {
                        let data = JSON.parse(http.responseText);

                        if (data['status']) {
                            button.innerHTML = "Success!";
                        } else {
                            button.innerHTML = "Error connecting...";
                        }
                        button.disabled = false;
                    }
                }
            }

            function save_config() {
                let http = new XMLHttpRequest();
                let url = '/api/save_connection';
                http.open("GET", url);
                http.send();

                http.onreadystatechange = function() {
                    if (this.readyState == 4) {
                        alert('Wifi data has been saved!');
                    }
                }
            }

            function reboot() {
                if(confirm('Are you sure you want to reboot?')) {
                    let http = new XMLHttpRequest();
                    let url = '/api/reboot';
                    http.open("GET", url);
                    http.send();

                    http.onreadystatechange = function() {
                        if (this.readyState == 4) {
                            alert('Pomo should be rebooting shortly...');
                        }
                    }
                }
            }

            function reset() {
                if (confirm('Are you sure you want to reset? This will erase all settings and stored tasks!')) {
                    let http = new XMLHttpRequest();
                    let url = '/api/reset';
                    http.open("GET", url);
                    http.send();

                    http.onreadystatechange = function() {
                        if (this.readyState == 4) {
                            alert('Pomo has been reset and is rebooting...');
                        }
                    }
                }
            }
        </script>

    </body>
</html>